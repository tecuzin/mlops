---
alwaysApply: true
---

# Stack technique et dépendances

## Langage et runtime

- Python 3.11+ (toutes les images Docker utilisent `python:3.11-slim`)
- Syntaxe moderne : `from __future__ import annotations`, union types `X | None`, `list[str]`

## Dépendances par service

### API FastAPI (`docker/Dockerfile.api`)
```
fastapi>=0.115
uvicorn[standard]>=0.32
sqlalchemy>=2.0
psycopg2-binary>=2.9
pydantic>=2.9
httpx>=0.27
```

### UI Streamlit (`docker/Dockerfile.ui`)
```
streamlit>=1.39
httpx>=0.27
pandas>=2.2
plotly>=5.24
```

### Worker Training (`docker/Dockerfile.training`)
```
httpx>=0.27
mlflow>=2.15
transformers>=4.44
peft>=0.12
datasets>=3.0
accelerate>=0.34
torch>=2.4
sentencepiece>=0.2
protobuf>=5.28
bitsandbytes>=0.44
psutil>=5.9
```

### Worker Evaluation (`docker/Dockerfile.evaluation`)
```
httpx>=0.27
mlflow>=2.15
ragas>=0.2
datasets>=3.0
torch>=2.4
langchain-mistralai>=0.2
transformers>=4.44
peft>=0.12
accelerate>=0.34
sentencepiece>=0.2
protobuf>=5.28
psutil>=5.9
```

### MLflow Server (`docker/Dockerfile.mlflow`)
- Image de base : `ghcr.io/mlflow/mlflow:v2.18.0`
- Ajout : `psycopg2-binary>=2.9` (backend PostgreSQL)

### Mode standalone (`requirements.txt`)
```
prefect>=3.0
mlflow>=2.15
ragas>=0.2
transformers>=4.44
peft>=0.12
datasets>=3.0
accelerate>=0.34
torch>=2.4
pydantic>=2.9
pyyaml>=6.0
sentencepiece>=0.2
protobuf>=5.28
bitsandbytes>=0.44
```

## Services externes requis

| Service | Usage | Variable d'env |
|---|---|---|
| PostgreSQL 16 | BDD app + BDD MLflow | `DATABASE_URL` |
| Mistral AI API | LLM juge pour RAGAS | `MISTRAL_API_KEY`, `MISTRAL_MODEL` |
| HuggingFace Hub | Téléchargement modèles | `HF_TOKEN` (optionnel) |

## Variables d'environnement (`.env.example`)

```
POSTGRES_USER=mlops
POSTGRES_PASSWORD=mlops
POSTGRES_DB=mlops
DATABASE_URL=postgresql://mlops:mlops@db:5432/mlops
API_URL=http://api:8000
MLFLOW_TRACKING_URI=http://mlflow:5000
POLL_INTERVAL=10
OUTPUT_DIR=/app/outputs
MISTRAL_API_KEY=xxxxxxxxxxxxxxxxxxxx
MISTRAL_MODEL=mistral-small-latest
# HF_TOKEN=hf_xxxxxxxxxxxxxxxxxxxx
```

## Conventions de code

- Tout le code métier est en Python
- Validation des données avec Pydantic (BaseModel, Field)
- ORM : SQLAlchemy 2.0 (style déclaratif avec DeclarativeBase)
- Imports : `from __future__ import annotations` en première ligne de chaque fichier
- Logging : module `logging` standard avec format `%(asctime)s [%(levelname)s] %(name)s: %(message)s`
- Communication inter-services : HTTP via `httpx`
- Secrets jamais en dur, toujours via `os.getenv()`
